        <section id="compact-command">
            <h2>The /compact Command: Context Compaction</h2>

            <p class="intro">
                The <code>/compact</code> command is Claude Code's built-in mechanism for managing context window overflow.
                It summarizes conversation history while preserving essential context, allowing longer productive sessions.
            </p>

            <!-- Process Flow Graph -->
            <div class="card">
                <h3><i class="pi pi-sitemap"></i> How /compact Works: Process Flow</h3>

                <div class="compact-flow-diagram">
                    <svg viewBox="0 0 900 400" class="flow-svg">
                        <!-- Background -->
                        <defs>
                            <linearGradient id="contextGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:#e74c3c;stop-opacity:0.8" />
                                <stop offset="50%" style="stop-color:#f39c12;stop-opacity:0.8" />
                                <stop offset="100%" style="stop-color:#27ae60;stop-opacity:0.8" />
                            </linearGradient>
                            <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="#64748b"/>
                            </marker>
                        </defs>

                        <!-- Stage 1: Full Context -->
                        <g transform="translate(50, 50)">
                            <rect x="0" y="0" width="160" height="120" rx="8" fill="#fee2e2" stroke="#ef4444" stroke-width="2"/>
                            <text x="80" y="25" text-anchor="middle" class="flow-title">BEFORE</text>
                            <text x="80" y="45" text-anchor="middle" class="flow-subtitle">Context at 95%</text>

                            <!-- Token blocks -->
                            <rect x="10" y="55" width="140" height="12" rx="2" fill="#ef4444" opacity="0.9"/>
                            <rect x="10" y="70" width="140" height="12" rx="2" fill="#f97316" opacity="0.8"/>
                            <rect x="10" y="85" width="140" height="12" rx="2" fill="#eab308" opacity="0.7"/>
                            <rect x="10" y="100" width="30" height="12" rx="2" fill="#94a3b8" opacity="0.3"/>

                            <text x="80" y="130" text-anchor="middle" class="flow-label">190K / 200K tokens</text>
                        </g>

                        <!-- Arrow 1 -->
                        <line x1="220" y1="110" x2="280" y2="110" stroke="#64748b" stroke-width="2" marker-end="url(#arrowhead)"/>
                        <text x="250" y="95" text-anchor="middle" class="flow-arrow-label">/compact</text>

                        <!-- Stage 2: Analysis -->
                        <g transform="translate(290, 50)">
                            <rect x="0" y="0" width="160" height="120" rx="8" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
                            <text x="80" y="25" text-anchor="middle" class="flow-title">ANALYZE</text>
                            <text x="80" y="45" text-anchor="middle" class="flow-subtitle">Categorize Content</text>

                            <!-- Analysis icons -->
                            <rect x="10" y="55" width="45" height="50" rx="4" fill="#22c55e" opacity="0.7"/>
                            <text x="32" y="85" text-anchor="middle" class="block-label">Keep</text>

                            <rect x="60" y="55" width="45" height="50" rx="4" fill="#3b82f6" opacity="0.7"/>
                            <text x="82" y="85" text-anchor="middle" class="block-label">Summary</text>

                            <rect x="110" y="55" width="40" height="50" rx="4" fill="#94a3b8" opacity="0.5"/>
                            <text x="130" y="85" text-anchor="middle" class="block-label">Drop</text>

                            <text x="80" y="130" text-anchor="middle" class="flow-label">Intelligent triage</text>
                        </g>

                        <!-- Arrow 2 -->
                        <line x1="460" y1="110" x2="520" y2="110" stroke="#64748b" stroke-width="2" marker-end="url(#arrowhead)"/>
                        <text x="490" y="95" text-anchor="middle" class="flow-arrow-label">Process</text>

                        <!-- Stage 3: Summarization -->
                        <g transform="translate(530, 50)">
                            <rect x="0" y="0" width="160" height="120" rx="8" fill="#dbeafe" stroke="#3b82f6" stroke-width="2"/>
                            <text x="80" y="25" text-anchor="middle" class="flow-title">SUMMARIZE</text>
                            <text x="80" y="45" text-anchor="middle" class="flow-subtitle">Compress History</text>

                            <!-- Compression visualization -->
                            <rect x="10" y="55" width="60" height="50" rx="4" fill="#3b82f6" opacity="0.6"/>
                            <text x="40" y="75" text-anchor="middle" class="block-label">50K</text>
                            <text x="40" y="90" text-anchor="middle" class="block-label-small">tokens</text>

                            <text x="85" y="80" text-anchor="middle" class="arrow-symbol">-></text>

                            <rect x="100" y="60" width="50" height="40" rx="4" fill="#22c55e" opacity="0.8"/>
                            <text x="125" y="80" text-anchor="middle" class="block-label">5K</text>
                            <text x="125" y="92" text-anchor="middle" class="block-label-small">summary</text>

                            <text x="80" y="130" text-anchor="middle" class="flow-label">~90% reduction</text>
                        </g>

                        <!-- Arrow 3 -->
                        <line x1="700" y1="110" x2="760" y2="110" stroke="#64748b" stroke-width="2" marker-end="url(#arrowhead)"/>
                        <text x="730" y="95" text-anchor="middle" class="flow-arrow-label">Result</text>

                        <!-- Stage 4: Result -->
                        <g transform="translate(770, 50)">
                            <rect x="0" y="0" width="120" height="120" rx="8" fill="#dcfce7" stroke="#22c55e" stroke-width="2"/>
                            <text x="60" y="25" text-anchor="middle" class="flow-title">AFTER</text>
                            <text x="60" y="45" text-anchor="middle" class="flow-subtitle">~40% Used</text>

                            <!-- Result blocks -->
                            <rect x="10" y="55" width="100" height="12" rx="2" fill="#22c55e" opacity="0.9"/>
                            <rect x="10" y="70" width="100" height="12" rx="2" fill="#22c55e" opacity="0.6"/>
                            <rect x="10" y="85" width="100" height="50" rx="2" fill="#94a3b8" opacity="0.2"/>

                            <text x="60" y="130" text-anchor="middle" class="flow-label">80K / 200K</text>
                        </g>

                        <!-- Bottom: What's preserved -->
                        <g transform="translate(50, 200)">
                            <text x="0" y="0" class="section-title">What Gets Preserved:</text>

                            <g transform="translate(0, 20)">
                                <rect x="0" y="0" width="200" height="60" rx="6" fill="#dcfce7" stroke="#22c55e"/>
                                <text x="100" y="20" text-anchor="middle" class="preserve-title">Essential Context</text>
                                <text x="100" y="38" text-anchor="middle" class="preserve-item">Key decisions & architecture</text>
                                <text x="100" y="52" text-anchor="middle" class="preserve-item">Recent interactions</text>
                            </g>

                            <g transform="translate(220, 20)">
                                <rect x="0" y="0" width="200" height="60" rx="6" fill="#dbeafe" stroke="#3b82f6"/>
                                <text x="100" y="20" text-anchor="middle" class="preserve-title">Summarized</text>
                                <text x="100" y="38" text-anchor="middle" class="preserve-item">Earlier conversations</text>
                                <text x="100" y="52" text-anchor="middle" class="preserve-item">Exploration history</text>
                            </g>

                            <g transform="translate(440, 20)">
                                <rect x="0" y="0" width="200" height="60" rx="6" fill="#fee2e2" stroke="#ef4444"/>
                                <text x="100" y="20" text-anchor="middle" class="preserve-title">Dropped</text>
                                <text x="100" y="38" text-anchor="middle" class="preserve-item">Redundant explanations</text>
                                <text x="100" y="52" text-anchor="middle" class="preserve-item">Intermediate attempts</text>
                            </g>

                            <g transform="translate(660, 20)">
                                <rect x="0" y="0" width="180" height="60" rx="6" fill="#fef3c7" stroke="#f59e0b"/>
                                <text x="90" y="20" text-anchor="middle" class="preserve-title">Custom Priority</text>
                                <text x="90" y="38" text-anchor="middle" class="preserve-item">Based on instructions</text>
                                <text x="90" y="52" text-anchor="middle" class="preserve-item">you provide</text>
                            </g>
                        </g>

                        <!-- Formula section -->
                        <g transform="translate(50, 320)">
                            <text x="0" y="0" class="section-title">Compaction Formula:</text>
                            <text x="0" y="30" class="formula">New_Context = Essential + Summary(History) + Recent_Messages</text>
                            <text x="0" y="55" class="formula-note">where Summary() achieves ~90% compression on historical content</text>
                        </g>
                    </svg>
                </div>
            </div>

            <!-- Timeline Graph -->
            <div class="card">
                <h3><i class="pi pi-chart-line"></i> Context Usage Over Time</h3>

                <div class="timeline-diagram">
                    <svg viewBox="0 0 800 300" class="timeline-svg">
                        <!-- Grid -->
                        <defs>
                            <pattern id="grid" width="40" height="30" patternUnits="userSpaceOnUse">
                                <path d="M 40 0 L 0 0 0 30" fill="none" stroke="#e2e8f0" stroke-width="0.5"/>
                            </pattern>
                        </defs>
                        <rect x="60" y="20" width="700" height="210" fill="url(#grid)"/>

                        <!-- Axes -->
                        <line x1="60" y1="230" x2="760" y2="230" stroke="#64748b" stroke-width="2"/>
                        <line x1="60" y1="20" x2="60" y2="230" stroke="#64748b" stroke-width="2"/>

                        <!-- Y-axis labels -->
                        <text x="50" y="25" text-anchor="end" class="axis-label">200K</text>
                        <text x="50" y="78" text-anchor="end" class="axis-label">150K</text>
                        <text x="50" y="130" text-anchor="end" class="axis-label">100K</text>
                        <text x="50" y="183" text-anchor="end" class="axis-label">50K</text>
                        <text x="50" y="233" text-anchor="end" class="axis-label">0</text>

                        <!-- Threshold lines -->
                        <line x1="60" y1="30" x2="760" y2="30" stroke="#ef4444" stroke-width="1" stroke-dasharray="5,5"/>
                        <text x="765" y="35" class="threshold-label danger">95% Auto-compact</text>

                        <line x1="60" y1="73" x2="760" y2="73" stroke="#f59e0b" stroke-width="1" stroke-dasharray="5,5"/>
                        <text x="765" y="78" class="threshold-label warning">75% Warning</text>

                        <!-- Usage line (before compact) -->
                        <path d="M 60 210
                                 Q 120 200, 150 180
                                 T 240 140
                                 T 330 100
                                 T 420 60
                                 T 480 40"
                              fill="none" stroke="#ef4444" stroke-width="3"/>

                        <!-- Compact event -->
                        <line x1="480" y1="40" x2="480" y2="150" stroke="#3b82f6" stroke-width="2" stroke-dasharray="3,3"/>
                        <circle cx="480" cy="40" r="6" fill="#ef4444"/>
                        <circle cx="480" cy="150" r="6" fill="#22c55e"/>
                        <text x="480" y="265" text-anchor="middle" class="event-label">/compact</text>

                        <!-- Usage line (after compact) -->
                        <path d="M 480 150
                                 Q 540 145, 570 130
                                 T 660 90
                                 T 750 50"
                              fill="none" stroke="#22c55e" stroke-width="3"/>

                        <!-- X-axis labels -->
                        <text x="60" y="250" text-anchor="middle" class="axis-label">Start</text>
                        <text x="270" y="250" text-anchor="middle" class="axis-label">Working...</text>
                        <text x="480" y="250" text-anchor="middle" class="axis-label">Compact</text>
                        <text x="620" y="250" text-anchor="middle" class="axis-label">Continue</text>
                        <text x="750" y="250" text-anchor="middle" class="axis-label">End</text>

                        <!-- Legend -->
                        <g transform="translate(100, 270)">
                            <rect x="0" y="0" width="15" height="10" fill="#ef4444"/>
                            <text x="20" y="10" class="legend-text">Before compact</text>

                            <rect x="150" y="0" width="15" height="10" fill="#22c55e"/>
                            <text x="170" y="10" class="legend-text">After compact</text>

                            <line x1="300" y1="5" x2="330" y2="5" stroke="#3b82f6" stroke-width="2" stroke-dasharray="3,3"/>
                            <text x="340" y="10" class="legend-text">Compaction drop</text>
                        </g>
                    </svg>
                </div>
            </div>

            <!-- Interactive Simulator -->
            <div class="card">
                <h3><i class="pi pi-play"></i> Interactive Compaction Simulator</h3>
                <p>Experiment with the /compact command to see how it affects your context window.</p>

                <div id="compact-simulator-container" class="simulator-container">
                    <!-- Populated by compact-simulator.js -->
                </div>
            </div>

            <!-- Detailed Explanation -->
            <div class="card">
                <h3><i class="pi pi-book"></i> Detailed Explanation</h3>

                <div class="explanation-grid">
                    <div class="explanation-section">
                        <h4>1. Trigger Conditions</h4>
                        <table class="compact-table">
                            <tr>
                                <th>Trigger</th>
                                <th>Condition</th>
                                <th>Action</th>
                            </tr>
                            <tr>
                                <td><code>/compact</code></td>
                                <td>Manual invocation</td>
                                <td>Immediate compaction with optional instructions</td>
                            </tr>
                            <tr>
                                <td>Auto-compact</td>
                                <td>Context >= 95%</td>
                                <td>Automatic compaction to prevent overflow</td>
                            </tr>
                        </table>
                    </div>

                    <div class="explanation-section">
                        <h4>2. Compaction Algorithm</h4>
                        <div class="algorithm-steps">
                            <div class="step">
                                <span class="step-num">1</span>
                                <div class="step-content">
                                    <strong>Categorization</strong>
                                    <p>Content is categorized as: Essential (recent, decisions), Historical (older context), Redundant (duplicates, verbose)</p>
                                </div>
                            </div>
                            <div class="step">
                                <span class="step-num">2</span>
                                <div class="step-content">
                                    <strong>Priority Scoring</strong>
                                    <p>Each segment receives a relevance score based on recency, importance, and user instructions</p>
                                </div>
                            </div>
                            <div class="step">
                                <span class="step-num">3</span>
                                <div class="step-content">
                                    <strong>Summarization</strong>
                                    <p>Lower-priority content is summarized using extractive compression (~90% reduction)</p>
                                </div>
                            </div>
                            <div class="step">
                                <span class="step-num">4</span>
                                <div class="step-content">
                                    <strong>Reconstruction</strong>
                                    <p>New context = Essential content + Summaries + System context</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="explanation-section">
                        <h4>3. Token Mathematics</h4>
                        <div class="formula-box">
                            <div class="formula-item">
                                <span class="formula-name">Compression Ratio:</span>
                                <code>R = 1 - (Output_Tokens / Input_Tokens)</code>
                                <span class="formula-typical">Typical: 85-95%</span>
                            </div>
                            <div class="formula-item">
                                <span class="formula-name">Post-Compact Size:</span>
                                <code>New_Size = Essential + (Historical * (1 - R))</code>
                            </div>
                            <div class="formula-item">
                                <span class="formula-name">Freed Tokens:</span>
                                <code>Freed = Original_Size - New_Size</code>
                            </div>
                        </div>

                        <div class="example-calc">
                            <h5>Example Calculation:</h5>
                            <ul>
                                <li>Original context: <strong>190,000 tokens</strong></li>
                                <li>Essential content: <strong>30,000 tokens</strong> (kept as-is)</li>
                                <li>Historical content: <strong>160,000 tokens</strong></li>
                                <li>Compression ratio: <strong>90%</strong></li>
                                <li>Compressed historical: <strong>16,000 tokens</strong></li>
                                <li>New context size: <strong>46,000 tokens</strong></li>
                                <li>Freed space: <strong>144,000 tokens (76%)</strong></li>
                            </ul>
                        </div>
                    </div>

                    <div class="explanation-section">
                        <h4>4. Best Practices</h4>
                        <div class="best-practices">
                            <div class="practice good">
                                <i class="pi pi-check-circle"></i>
                                <div>
                                    <strong>Use with instructions</strong>
                                    <p><code>/compact Focus on API changes and test results</code></p>
                                </div>
                            </div>
                            <div class="practice good">
                                <i class="pi pi-check-circle"></i>
                                <div>
                                    <strong>Compact before major pivots</strong>
                                    <p>Clear old context when switching to unrelated work</p>
                                </div>
                            </div>
                            <div class="practice good">
                                <i class="pi pi-check-circle"></i>
                                <div>
                                    <strong>Monitor with /cost</strong>
                                    <p>Track token usage to time compaction optimally</p>
                                </div>
                            </div>
                            <div class="practice bad">
                                <i class="pi pi-times-circle"></i>
                                <div>
                                    <strong>Don't compact too frequently</strong>
                                    <p>Each compact loses some nuance; use judiciously</p>
                                </div>
                            </div>
                            <div class="practice bad">
                                <i class="pi pi-times-circle"></i>
                                <div>
                                    <strong>Don't rely solely on auto-compact</strong>
                                    <p>Manual compaction with instructions preserves more context</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Hook Integration -->
            <div class="card">
                <h3><i class="pi pi-cog"></i> Hook Integration: PreCompact</h3>
                <p>Claude Code provides a <code>PreCompact</code> hook that executes before compaction:</p>

                <div class="code-block">
                    <pre><code class="language-json">{
  "hooks": {
    "PreCompact": [
      {
        "matcher": "manual",  // or "auto"
        "hooks": [
          {
            "type": "command",
            "command": "echo 'Compacting...' >> ~/.claude/compact.log"
          }
        ]
      }
    ]
  }
}</code></pre>
                </div>

                <div class="hook-info">
                    <h4>Hook Input Contains:</h4>
                    <ul>
                        <li><code>session_id</code> - Current session identifier</li>
                        <li><code>transcript_path</code> - Path to conversation history</li>
                        <li><code>trigger</code> - Either "manual" or "auto"</li>
                        <li><code>custom_instructions</code> - User-provided instructions (if any)</li>
                    </ul>
                </div>
            </div>

            <!-- Quick Reference -->
            <div class="card reference-card">
                <h3><i class="pi pi-list"></i> Quick Reference</h3>

                <table class="reference-table">
                    <tr>
                        <th>Aspect</th>
                        <th>Details</th>
                    </tr>
                    <tr>
                        <td>Command</td>
                        <td><code>/compact [instructions]</code></td>
                    </tr>
                    <tr>
                        <td>Auto-trigger</td>
                        <td>95% context capacity</td>
                    </tr>
                    <tr>
                        <td>Typical compression</td>
                        <td>85-95% of historical content</td>
                    </tr>
                    <tr>
                        <td>Result</td>
                        <td>~40-60% of original size</td>
                    </tr>
                    <tr>
                        <td>Hook event</td>
                        <td><code>PreCompact</code> (manual/auto)</td>
                    </tr>
                    <tr>
                        <td>Configuration</td>
                        <td><code>/config</code> > Auto-compact enabled</td>
                    </tr>
                    <tr>
                        <td>Monitoring</td>
                        <td><code>/cost</code> command</td>
                    </tr>
                </table>
            </div>
        </section>
